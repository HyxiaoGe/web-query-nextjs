# 限流系统说明

## 📋 概述

为了保护搜索服务免受过度使用和恶意攻击，系统实现了多层限流机制。该系统能够有效控制并发请求、防止单个IP过度使用，并优化整体服务性能。

## 🛡️ 限流策略

### 1. **全局限流** - 保护后端服务
- **并发限制**: 最多同时处理10个搜索请求
- **频率限制**: 每分钟最多处理100个搜索请求
- 目的：防止SearxNG和系统资源过载

### 2. **IP限流** - 防止单个IP过度使用
- **分钟级限制**: 单个IP每分钟最多20个请求
- **小时级限制**: 单个IP每小时最多200个请求
- 目的：确保资源公平分配，防止滥用

### 3. **搜索词限流** - 防止重复搜索
- **限制**: 同一IP对同一查询词每分钟最多5次请求
- 目的：减少无意义的重复搜索，提高缓存效率

## ⚙️ 配置参数

可通过环境变量配置限流参数：

```bash
# 全局限流配置
GLOBAL_RATE_LIMIT_PER_MINUTE=100      # 全局每分钟请求数
MAX_CONCURRENT_REQUESTS=10            # 最大并发请求数

# IP限流配置
IP_RATE_LIMIT_PER_MINUTE=20          # 单IP每分钟请求数
IP_RATE_LIMIT_PER_HOUR=200           # 单IP每小时请求数

# 查询限流配置
QUERY_RATE_LIMIT_PER_MINUTE=5        # 同一查询每分钟请求数
```

## 🔍 监控与状态

### 安全考虑
⚠️ **重要**: 限流配置和状态信息属于敏感的系统内部信息，不应该向普通用户公开展示，以防止被恶意利用来优化攻击策略。

### 管理员监控
仅限系统管理员通过内部接口监控限流状态：

- **管理员API**: `GET /api/admin/rate-limit` (需要认证)
- **认证方式**: Bearer Token (通过 `ADMIN_API_KEY` 环境变量设置)
- **访问权限**: 仅限系统管理员

### 状态指示（内部使用）
- 🟢 **正常** (0-50%): 系统负载较低
- 🟡 **中等负载** (50-80%): 系统负载适中
- 🔴 **高负载** (80-100%): 系统负载较高，接近限制

## 📊 响应处理

### 正常请求
```json
{
  "success": true,
  "results": [...],
  // ... 其他响应数据
}
```

### 限流触发
当请求被限流时，API返回HTTP 429状态码：

```json
{
  "success": false,
  "error": "Too many requests from your IP. Please slow down.",
  "timestamp": "2025-01-29T12:00:00.000Z",
  "retryAfter": 60
}
```

响应头信息：
- `Retry-After`: 建议重试等待时间（秒）
- `X-RateLimit-Reason`: 限流原因说明

## 🚨 限流场景

### 1. 全局并发超限
**触发条件**: 同时有超过10个搜索请求在处理
**错误信息**: "Too many concurrent requests. Please try again later."
**建议**: 等待10秒后重试

### 2. 全局频率超限
**触发条件**: 系统每分钟处理超过100个请求
**错误信息**: "Global rate limit exceeded. Please try again later."
**建议**: 等待60秒后重试

### 3. IP频率超限
**触发条件**: 单个IP请求过于频繁
**错误信息**: "Too many requests from your IP. Please slow down."
**建议**: 降低请求频率，等待后重试

### 4. 重复搜索超限
**触发条件**: 短时间内重复搜索同一关键词
**错误信息**: "Too many searches for the same query. Please wait a moment."
**建议**: 避免重复搜索，等待后重试

## 💡 最佳实践

### 对于前端应用
1. **实现重试机制**: 根据`retryAfter`字段设置重试延迟
2. **显示友好提示**: 告知用户请求过于频繁，需要等待
3. **避免重复请求**: 实现防抖或节流机制
4. **缓存搜索结果**: 减少不必要的重复请求

### 对于API调用
1. **检查响应状态**: 正确处理429状态码
2. **指数退避策略**: 连续失败时逐渐增加重试间隔
3. **监控使用情况**: 跟踪限流触发频率，优化调用模式

## 🔧 故障排除

### 常见问题

**Q: 为什么我的请求被限流了？**
A: 检查是否超过了任何一种限流策略的阈值。查看监控面板了解当前状态。

**Q: 如何提高限流阈值？**
A: 修改环境变量中的限流配置，重启服务生效。

**Q: 限流数据存储在哪里？**
A: 限流计数器存储在Redis中，具有自动过期机制。

**Q: 如何重置限流计数？**
A: 限流计数会自动过期，也可以重启Redis服务清空所有计数。

### 调试信息
开发环境下，限流触发会在控制台输出详细日志信息，包括：
- 触发的限流类型
- 当前计数值
- 限制阈值
- 客户端IP信息

## 📈 性能影响

### 优势
- **保护系统稳定性**: 防止过载导致的服务不可用
- **提升用户体验**: 确保响应时间稳定
- **公平资源分配**: 防止少数用户占用过多资源

### 开销
- **Redis访问**: 每个请求需要读写Redis计数器
- **内存使用**: 存储限流计数器数据
- **响应延迟**: 增加约1-2ms的检查时间

总体而言，限流系统的性能开销很小，带来的稳定性收益远大于成本。